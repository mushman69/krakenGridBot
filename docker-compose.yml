version: '3.8'

services:
  gridbot:
    build: .
    container_name: kraken_gridbot_pnl
    restart: unless-stopped
    env_file:
      - ./kraken.env  # Load credentials from kraken.env file
    environment:
      - DATABASE_FILE=/app/data/gridbot_pnl.db
      - PNL_REPORT_INTERVAL=300
      - DOCKER_DEPLOYMENT=1
      - TZ=UTC
    volumes:
      # Persistent data storage
      - ./data:/app/data
      - ./exports:/app/exports 
      - ./charts:/app/charts
      - ./logs:/app/logs
      # Mount your environment file
      - ./kraken.env:/app/kraken.env:ro
    
    # Health check to ensure bot is running
    healthcheck:
      test: ["CMD", "python", "-c", "import sqlite3; print('OK')"]
      interval: 5m
      timeout: 10s
      retries: 3
      start_period: 30s

  # Optional: PnL analyzer service for live monitoring
  pnl-monitor:
    build: .
    container_name: kraken_pnl_monitor
    restart: "no"  # Run manually when needed
    environment:
      - DATABASE_FILE=/app/data/gridbot_pnl.db
    volumes:
      - ./data:/app/data:ro  # Read-only access to data
      - ./exports:/app/exports
      - ./charts:/app/charts
    command: ["python", "pnl_analyzer.py", "--live"]
    profiles:
      - monitoring  # Only start with: docker-compose --profile monitoring up

volumes:
  gridbot_data:
    driver: local
